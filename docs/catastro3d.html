<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catastro 3D - Mi barrio: Potosí</title>

  <!-- Estilos del proyecto actual -->
  <style>
    /* Importar la tipografía Delius desde Google Fonts */
    @import url('https://fonts.googleapis.com/css2?family=Delius&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap');

    /* Variables globales del estilo actual */
    :root {
      --menu-h: 64px;
      --logo-h: 96px;
      --menu-bg: #0d8d82;
      --menu-bg-hover: #09b1a3c5;
      --text-on-menu: #ffffff;
      --page-bg: #ffffff;
      --inicio-bg: #f3ebe9;
      --border: #e5e7eb;
      --title-color: #0f172a;
      --title-size: 50px;
      --main-font: "Delius", cursive;
    }

    /* Reset / Base */
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      background: var(--page-bg);
      font-family: var(--main-font);
      color: var(--title-color);
      width: 100%;
      height: 100%;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Cabecera del proyecto actual */
    header.topbar {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      height: calc(var(--menu-h) * 2);
      padding: 0 16px;
      background: var(--inicio-bg);
      border-bottom: 1px solid var(--border);
      position: relative;
      z-index: 1001;
    }

    .topbar .left,
    .topbar .right {
      display: flex;
      align-items: center;
      min-width: 0;
    }

    #logo {
      height: var(--logo-h);
      max-height: calc(var(--menu-h) * 1.8);
      width: auto;
      border-radius: 50%;
      object-fit: cover;
      display: block;
    }

    .topbar .left { justify-content: flex-start; }

    .title {
      grid-column: 2;
      margin: 0;
      text-align: center;
      font-size: var(--title-size);
      font-weight: 800;
    }

    /* Navbar del proyecto actual */
    .navbar {
      height: var(--menu-h);
      background: var(--menu-bg);
      width: 100%;
      border-bottom: 1px solid var(--border);
      z-index: 1001;
      position: relative;
    }

    .menu {
      list-style: none;
      margin: 0;
      padding: 0 12px;
      display: flex;
      align-items: stretch;
      height: 100%;
      justify-content: center;
      gap: 0;
    }

    .menu-item {
      position: relative;
    }

    .menu-link {
      display: flex;
      align-items: center;
      padding: 0 20px;
      height: 100%;
      color: var(--text-on-menu);
      text-decoration: none;
      font-weight: 600;
      white-space: nowrap;
    }

    .menu-link:hover {
      background: var(--menu-bg-hover);
    }

    .submenu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: var(--menu-bg);
      min-width: 200px;
      margin: 6px 0 0 0;
      padding: 6px 0;
      box-shadow: 0 8px 16px rgba(0,0,0,0.12);
      border-radius: 8px;
      z-index: 1000;
    }

    .submenu li { list-style: none; }

    .submenu a {
      display: block;
      padding: 10px 14px;
      color: var(--text-on-menu);
      text-decoration: none;
    }

    .submenu a:hover {
      background: var(--menu-bg-hover);
    }

    .menu-item:hover > .submenu {
      display: block;
    }

    /* Contenedor principal combinando ambos estilos */
    #contenedor-principal {
      position: absolute;
      top: calc(var(--menu-h) * 3); /* debajo del header + navbar */
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      background: #f0f0f0;
    }

    /* Título del barrio del estilo inicial */
    #titulo-barrio {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0);
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 150px;
      font-weight: bold;
      color: #ffffff9d;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      pointer-events: none;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      max-width: 100%;
      border: 1px solid #ffffff00;
      font-family: 'Montserrat', Arial, sans-serif;
    }

    /* Contenedor vertical solo para Cesium */
    #contenedor-vertical {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 95%;
      height: calc(100% - 40px);
      box-sizing: border-box;
      z-index: 10;
    }

    /* Recuadro del visor Cesium ocupando todo el espacio */
    #recuadro-cesium {
      width: 100%;
      height: 100%;
      border: 3px solid #000000;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      background: white;
    }

    #cesiumContainer {
      width: 100%;
      height: 100%;
      position: relative;
    }

    /* Responsive */
    @media (max-width: 768px) {
      :root { --menu-h: 56px; }
      :root { --logo-h: 72px; }
      .title { font-size: 20px; }
      .menu { justify-content: center; }
      .menu-link { padding: 0 12px; }
      #titulo-barrio { font-size: 80px; }
    }

    @media (max-width: 480px) {
      :root { --menu-h: 48px; }
      :root { --logo-h: 56px; }
      .title { font-size: 18px; }
      #titulo-barrio { font-size: 60px; }
    }

    /* Contenedor vertical solo para Cesium */
    #contenedor-vertical {
      width: 95%;
      height: calc(100% - 40px);
    }
  </style>

  <!-- LibrerÃ­a Cesium con la versión que funcionaba -->
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.132/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.132/Build/Cesium/Cesium.js"></script>
</head>
<body>

  <!-- Cabecera del proyecto actual -->
  <header class="topbar" role="banner">
    <div class="left">
      <img id="logo" src="./assets/logo_redondo_256.png" alt="Logo Mi Barrio" />
    </div>
    <h1 class="title">Mi barrio: Potosí</h1>
    <div class="right"></div>
  </header>

  <!-- Menú del proyecto actual -->
  <nav class="navbar" role="navigation" aria-label="Menú principal">
    <ul class="menu">
      <li class="menu-item">
        <a href="index.html" class="menu-link">Inicio</a>
      </li>
      <li class="menu-item">
        <a href="#" class="menu-link">Equipamientos</a>
        <ul class="submenu">
          <li><a href="#">Movilidad</a></li>
          <li><a href="#">Troncales</a></li>
          <li><a href="#">Parques</a></li>
          <li><a href="#">Vías</a></li>
        </ul>
      </li>
      <li class="menu-item">
        <a href="#" class="menu-link">Problemática</a>
        <ul class="submenu">
          <li><a href="#">Por definir</a></li>
        </ul>
      </li>
      <li class="menu-item">
        <a href="#" class="menu-link">Acerca de</a>
        <ul class="submenu">
          <li><a href="ubicacion.html">Ubicación</a></li>
          <li><a href="catastro3d.html">Catastro 3D</a></li>
          <li><a href="#">Recorrido virtual</a></li>
        </ul>
      </li>
    </ul>
  </nav>

  <!-- Contenedor principal -->
  <div id="contenedor-principal">
    
    <!-- Contenedor vertical solo con Cesium -->
    <div id="contenedor-vertical">
      
      <!-- Recuadro del visor Cesium -->
      <div id="recuadro-cesium">
        <div id="cesiumContainer"></div>
      </div>

    </div>
  </div>

  <!-- Script de Cesium (funcionalidad del inicial que funcionaba) -->
  <script>
    // Token de Cesium Ion
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIxNzI1ZjBlNS1hNmY4LTQ0OGEtYjE5OS1hMGJiYjYzMmNhOGIiLCJpZCI6MzMxMzc2LCJpYXQiOjE3NTUwNDI2Mjd9.vMkh7Pvq2F9MhZE4H7wqPFFQs1gPKdc-Ax4q0tncRs8';

    // Función principal async
    async function initializeCesium() {
      try {
        // Inicializar el visor de Cesium
        const viewer = new Cesium.Viewer("cesiumContainer", {
          terrain: Cesium.Terrain.fromWorldTerrain(),
          baseLayer: Cesium.ImageryLayer.fromProviderAsync(
            Cesium.ArcGisMapServerImageryProvider.fromBasemapType(
              Cesium.ArcGisBaseMapType.SATELLITE
            )
          ),
          timeline: false,
          animation: false,
          shadows: true
        });

        // Activar prueba de profundidad contra el terreno
        viewer.scene.globe.depthTestAgainstTerrain = true;

        // 1) Carga del barrio con manejo de errores
        try {
          const barrio = await Cesium.GeoJsonDataSource.load("Potosi.geojson", {
            clampToGround: true
          });
          viewer.dataSources.add(barrio);

          // Estilo visual del barrio
          for (const e of barrio.entities.values) {
            if (!e.polygon) continue;
            e.polygon.material = Cesium.Color.fromCssColorString("#ff9800").withAlpha(0.25);
            e.polygon.outline = true;
            e.polygon.outlineColor = Cesium.Color.fromCssColorString("#0d47a1");
          }

          // Centra la cámara en el barrio
          await viewer.flyTo(barrio);
        } catch (error) {
          console.error("Error cargando Potosi.geojson:", error);
          // Fallback a coordenadas manuales
          viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromDegrees(-74.082449, 4.688547, 3000),
            orientation: { heading: 0, pitch: Cesium.Math.toRadians(-25) }
          });
        }

        // 2) PREDIOS con manejo de errores
        try {
          const predios = await Cesium.GeoJsonDataSource.load("Predios-Potosi.geojson");
          viewer.dataSources.add(predios);

          for (const e of predios.entities.values) {
            const pol = e.polygon;
            if (!pol) continue;

            const props = e.properties || {};
            const hasAltura = props.altura && !isNaN(+props.altura.getValue?.());
            const hasPisos = props.pisos && !isNaN(+props.pisos.getValue?.());
            const altura = hasAltura ? +props.altura.getValue()
                          : hasPisos ? +props.pisos.getValue() * 3
                                    : 6;

            pol.material = Cesium.Color.fromCssColorString("#9e9e9e").withAlpha(0.95);
            pol.outline = true;
            pol.outlineColor = Cesium.Color.BLACK;
            pol.height = 0;
            pol.heightReference = Cesium.HeightReference.RELATIVE_TO_GROUND;
            pol.extrudedHeight = altura;
            pol.extrudedHeightReference = Cesium.HeightReference.RELATIVE_TO_GROUND;
          }
        } catch (error) {
          console.error("Error cargando Predios-Potosi.geojson:", error);
        }

        // 3) Cargar vías con manejo de errores
        try {
          const viasDataSource = await Cesium.GeoJsonDataSource.load("Vias.geojson", {
            clampToGround: true
          });
          viewer.dataSources.add(viasDataSource);
          console.log("Vías cargadas:", viasDataSource.entities.values.length, "entidades");

          viasDataSource.entities.values.forEach(entity => {
            if (entity.polyline) {
              entity.polyline.width = 3;
              entity.polyline.material = new Cesium.PolylineOutlineMaterialProperty({
                color: Cesium.Color.YELLOW,
                outlineColor: Cesium.Color.BLACK,
                outlineWidth: 1
              });
              entity.polyline.clampToGround = true;
            }
          });
        } catch (error) {
          console.error("Error cargando Vias.geojson:", error);
        }

      } catch (error) {
        console.error("Error inicializando Cesium:", error);
      }
    }

    // Esperar a que se cargue la página
    document.addEventListener('DOMContentLoaded', initializeCesium);
  </script>

</body>
</html>